# ğŸ“– Epoll Server Core å¼€å‘è€…æ‰‹å†Œ

æ¬¢è¿ä½¿ç”¨ **Epoll Server Core**ï¼

è¿™ä»½æ–‡æ¡£æ—¨åœ¨å¸®åŠ©ä½ â€”â€”åº”ç”¨å¼€å‘è€…ï¼Œå®Œå…¨æŒæ¡è¿™ä¸ªæ¡†æ¶çš„ä½¿ç”¨æ–¹æ³•ã€‚æ— è®ºä½ æ˜¯æƒ³å¿«é€Ÿå†™ä¸€ä¸ª JSON APIï¼Œè¿˜æ˜¯æƒ³æ·±å…¥åº•å±‚ç²¾ç»†æ§åˆ¶æ¯ä¸€ä¸ª HTTP å­—èŠ‚ï¼Œè¿™é‡Œéƒ½æœ‰ä½ éœ€è¦çš„ä¸€åˆ‡ã€‚

---

## 1. ğŸ› ï¸ æ„å»ºä¸è¿è¡Œæœºåˆ¶

æœ¬é¡¹ç›®é‡‡ç”¨äº†â€œåº“ + åº”ç”¨â€çš„åˆ†ç¦»æ¶æ„ï¼Œå› æ­¤æ„å»ºç³»ç»Ÿä¹Ÿç¨å¾®ç‹¬ç‰¹ä¸€äº›ã€‚æˆ‘ä»¬ä¸ºä½ æä¾›äº†å‡ ä¸ªæ–¹ä¾¿çš„ `make` æŒ‡ä»¤ã€‚

### ç›®å½•ç»“æ„å›é¡¾
*   `epoll_server_core/`: æ¡†æ¶æºç ï¼ˆè„æ´»ç´¯æ´»éƒ½åœ¨è¿™ï¼‰ã€‚
*   `user_backend/`: **ä½ çš„å·¥ä½œç›®å½•**ã€‚ä½ çš„ä¸šåŠ¡ä»£ç ã€`Makefile` å’Œå¯åŠ¨è„šæœ¬éƒ½åœ¨è¿™é‡Œã€‚

### å¸¸ç”¨æ„å»ºæŒ‡ä»¤

æ‰€æœ‰å‘½ä»¤è¯·åœ¨ `user_backend/` ç›®å½•ä¸‹æ‰§è¡Œï¼š

| å‘½ä»¤ | ä½œç”¨ | åœºæ™¯ |
| :--- | :--- | :--- |
| `make` | **å¢é‡ç¼–è¯‘**ã€‚åªç¼–è¯‘ä½ ä¿®æ”¹è¿‡çš„æ–‡ä»¶ã€‚å¦‚æœæ ¸å¿ƒåº“æœ‰å˜åŠ¨ï¼Œå®ƒä¹Ÿä¼šè‡ªåŠ¨å»è§¦å‘æ ¸å¿ƒåº“çš„ç¼–è¯‘ã€‚ | æ—¥å¸¸å¼€å‘è°ƒè¯•ï¼Œæœ€å¸¸ç”¨ã€‚ |
| `make clean` | **æ¸…ç†åº”ç”¨**ã€‚åªæ¸…é™¤ `user_backend` ç”Ÿæˆçš„ `.o` å’Œå¯æ‰§è¡Œæ–‡ä»¶ã€‚ | å½“ä½ åªæƒ³é‡ç¼–ä¸šåŠ¡é€»è¾‘æ—¶ã€‚ |
| `make clean_all` | **å½»åº•æ¸…ç†**ã€‚è¿åŒ `../epoll_server_core` é‡Œçš„é™æ€åº“å’Œä¸­é—´æ–‡ä»¶ä¸€èµ·åˆ æ‰ã€‚ | å½“ä½ ä¿®æ”¹äº†æ ¸å¿ƒåº“ä»£ç ï¼Œæˆ–è€…é‡åˆ°å¥‡æ€ªçš„é“¾æ¥é”™è¯¯æ—¶ã€‚ |
| `make rebuild` | **å…¨é‡é‡å»º**ã€‚å…ˆæ‰§è¡Œ `clean_all`ï¼Œå†æ‰§è¡Œ `make`ã€‚ | æƒ³è¦ä¸€ä¸ªå¹²å‡€ã€å…¨æ–°çš„æ„å»ºç¯å¢ƒæ—¶ã€‚ |

### å¯åŠ¨æœåŠ¡å™¨

ç¼–è¯‘æˆåŠŸåï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä½äº `bin/server_app`ã€‚
**æ³¨æ„**ï¼šä¸ºäº†è®©æœåŠ¡å™¨çŸ¥é“å¦‚ä½•è¿è¡Œï¼Œ**å¼ºçƒˆå»ºè®®**åœ¨å¯åŠ¨æ—¶æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼š

```bash
# æ ‡å‡†å¯åŠ¨æ–¹å¼
./bin/server_app conf/server.conf
```

å¦‚æœä¸æŒ‡å®šï¼ŒæœåŠ¡å™¨è™½ç„¶ä¼šä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤å€¼å¯åŠ¨ï¼ˆç«¯å£ 8080ï¼‰ï¼Œä½†è¿™ä¸æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

---

## 2. âš™ï¸ é…ç½®æ–‡ä»¶è¯¦è§£ (`server.conf`)

`server.conf` æ˜¯æœåŠ¡å™¨çš„æ§åˆ¶å°ã€‚æ”¯æŒ `#` æ³¨é‡Šï¼Œæ ¼å¼ä¸º `Key = Value`ã€‚

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
| :--- | :--- | :--- |
| **ListenPort** | æœåŠ¡å™¨ç›‘å¬çš„ TCP ç«¯å£ã€‚ | `8888` |
| **DocumentRoot** | é™æ€æ–‡ä»¶ï¼ˆHTML/CSS/JSï¼‰å­˜æ”¾çš„æ ¹ç›®å½•ã€‚ç›¸å¯¹äº `user_backend/` è¿è¡Œç›®å½•ã€‚ | `www` |
| **LogPath** | æ—¥å¿—æ–‡ä»¶å­˜æ”¾çš„ç›®å½•ã€‚ | `log` |
| **LogLevel** | æ—¥å¿—è¯¦ç»†ç¨‹åº¦ã€‚å¯é€‰ï¼š`DEBUG`, `INFO`, `WARNING`, `ERROR`ã€‚è°ƒè¯•æ—¶å¼€ DEBUGï¼Œä¸Šçº¿å¼€ INFOã€‚ | `DEBUG` |
| **LogTarget** | æ—¥å¿—è¾“å‡ºç›®æ ‡ã€‚å¯é€‰ï¼š`stdout` (æ§åˆ¶å°), `file` (æ–‡ä»¶)ã€‚ | `file` |
| **MimeEnabled** | æ˜¯å¦å¯ç”¨æ ¹æ®æ–‡ä»¶åç¼€è‡ªåŠ¨åˆ¤æ–­ Content-Typeã€‚ | `1` |
| **JwtEnabled** | æ˜¯å¦å¯ç”¨ JWT éªŒè¯é€»è¾‘ï¼ˆå¦‚æœä¸å¯ç”¨ï¼Œ`/api/me` ç­‰æ¥å£å¯èƒ½éœ€è¦é…åˆ mock token æµ‹è¯•ï¼‰ã€‚ | `1` |

> **å…³äº JwtSecret**ï¼šç›®å‰ JWT ç­¾åç§˜é’¥æš‚æ—¶ç¡¬ç¼–ç åœ¨æ ¸å¿ƒåº“ä¸­ï¼ˆ`auth.c` / `config.c`ï¼‰ï¼Œæš‚æœªæš´éœ²åˆ°é…ç½®æ–‡ä»¶ã€‚ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ—¶è¯·ä¿®æ”¹æºç ä¸­çš„é»˜è®¤å€¼ã€‚

---

## 3. ğŸ“¨ ç©è½¬ Request (`HttpRequest`)

åœ¨ä½ çš„å›è°ƒå‡½æ•°ä¸­ï¼Œ`conn->request` æ˜¯ä½ è·å–ä¸€åˆ‡ä¿¡æ¯çš„æºå¤´ã€‚
ä¸ºäº†è®©ä½ ç”¨å¾—çˆ½ï¼Œæˆ‘ä»¬å¯¹å‚æ•°è§£æåšäº†å¤§é‡è‡ªåŠ¨åŒ–å·¥ä½œï¼Œ**ä½ å‡ ä¹ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `free`**ã€‚

### 3.1 æ ¸å¿ƒå­—æ®µæ¦‚è§ˆ

```c
typedef struct {
    char method[8];      // "GET", "POST", etc.
    char raw_uri[2048];  // åŸå§‹ URIï¼Œå¦‚ "/api/search?q=abc"
    char* body;          // è¯·æ±‚ä½“åŸå§‹å†…å®¹ï¼ˆå¦‚æœæ˜¯æ–‡æœ¬/è¡¨å•ï¼‰
    size_t content_length;
    
    // Header ä¿¡æ¯ (Max 32 headers)
    HttpHeader headers[32]; 
    int header_count;

    // é‰´æƒç›¸å…³
    const char* auth_token; // å¦‚æœæœ‰ Authorization å¤´ï¼Œè¿™é‡Œæ˜¯ Bearer Token
    char* authed_user;      // éªŒè¯é€šè¿‡åçš„ç”¨æˆ·å
    
    // ... è‡ªåŠ¨è§£æçš„å­—æ®µ ...
    yyjson_doc* json_doc;   // [Phase 3] å¦‚æœæ˜¯ JSON è¯·æ±‚ï¼Œè¿™é‡Œå­˜ç€æ–‡æ¡£
    yyjson_val* json_root;  // [Phase 3] JSON æ ¹èŠ‚ç‚¹
} HttpRequest;
```

> **æ³¨æ„**ï¼šç›®å‰çš„å®ç°ä¸­ï¼ŒHeader æ•°é‡ä¸Šé™ä¸º 32ï¼Œå‚æ•°æ•°é‡ä¸Šé™ä¸º 32ã€‚è¶…å‡ºéƒ¨åˆ†ä¼šè¢«ä¸¢å¼ƒã€‚è¿™åœ¨ç»å¤§å¤šæ•°è½»é‡çº§åœºæ™¯ä¸‹æ˜¯è¶³å¤Ÿçš„ã€‚

### 3.2 è·å–å‚æ•°ï¼ˆQuery & Formï¼‰

æ¡†æ¶åœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šè‡ªåŠ¨è§£æï¼š
1.  URL ä¸­çš„ Query String (å¦‚ `?id=1&name=test`)ã€‚
2.  è¯·æ±‚ä½“ä¸­çš„è¡¨å•æ•°æ® (`application/x-www-form-urlencoded`)ã€‚

ä½ åªéœ€è¦ä½¿ç”¨ç»Ÿä¸€çš„æ¥å£æ¥è·å–å®ƒä»¬ï¼Œ**æ— éœ€å…³å¿ƒå†…å­˜ç®¡ç†**ï¼š

```c
// åœºæ™¯ï¼šGET /api/search?keyword=hello
// æˆ–è€…ï¼šPOST /api/login (body: username=admin&password=123)

// 1. é€šç”¨è·å–ï¼ˆæ¨èï¼‰ï¼šå…ˆæ‰¾ Queryï¼Œå†æ‰¾ Body
const char* val = http_get_param(&conn->request, "keyword");

// 2. å¼ºåˆ¶ä» Query String è·å–
const char* q_val = http_get_query_param(&conn->request, "id");

// 3. å¼ºåˆ¶ä» Body è¡¨å•è·å–
const char* b_val = http_get_body_param(&conn->request, "username");
```

> **æ³¨æ„**ï¼šè¿”å›çš„å­—ç¬¦ä¸²æŒ‡é’ˆç”Ÿå‘½å‘¨æœŸä¸ `Connection` ç»‘å®šï¼Œ**åƒä¸‡ä¸è¦æ‰‹åŠ¨ free å®ƒ**ï¼

### 3.3 å¤„ç† JSON è¯·æ±‚

å¦‚æœå®¢æˆ·ç«¯å‘é€çš„ Header ä¸­åŒ…å« `Content-Type: application/json`ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨è°ƒç”¨ `yyjson` è§£æè¯·æ±‚ä½“ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ª Headerï¼Œåˆ™ä¸ä¼šè§¦å‘è§£æã€‚

```c
// å‡è®¾è¯·æ±‚ä½“æ˜¯: {"name": "William", "age": 18}

void handle_json_api(Connection* conn, ServerConfig* config, int epollFd) {
    // 1. æ£€æŸ¥æ˜¯å¦æˆåŠŸè§£æäº† JSON
    if (!conn->request.json_root) {
        http_send_error(conn, 400, "Bad Request: JSON expected", epollFd);
        return;
    }

    // 2. ä½¿ç”¨ yyjson è¯»å–å­—æ®µ (æ— éœ€ free)
    yyjson_val* root = conn->request.json_root;
    const char* name = yyjson_get_str(yyjson_obj_get(root, "name"));
    int age = yyjson_get_int(yyjson_obj_get(root, "age"));

    // ... ä¸šåŠ¡é€»è¾‘ ...
}
```

---

## 4. ğŸ“¤ æŒæ§ Response (`HttpResponse`)

å¯¹äºå“åº”ï¼Œæˆ‘ä»¬æä¾›äº†ä¸¤ç§æˆªç„¶ä¸åŒçš„ä½¿ç”¨æ¨¡å¼ã€‚
**ç‰¹åˆ«æ³¨æ„**ï¼šç›®å‰çš„å®ç°ä¸æ”¯æŒ Keep-Aliveã€‚è°ƒç”¨å‘é€å‡½æ•°åï¼Œè¿æ¥ä¼šè¢«æ ‡è®°ä¸ºå…³é—­ã€‚

### æ¨¡å¼ Aï¼šæé€Ÿå“åº” (Helper Functions) ğŸš€

å¦‚æœä½ åªæƒ³å¿«é€Ÿè¿”å›ç»“æœï¼Œä¸æƒ³å…³å¿ƒ HTTP åè®®ç»†èŠ‚ï¼Œè¯·ä½¿ç”¨å¿«æ·å‡½æ•°ã€‚å®ƒä»¬ä¼šè‡ªåŠ¨å¤„ç† Content-Lengthã€Header å’Œå‘é€é˜Ÿåˆ—ã€‚

| å‡½æ•° | ä½œç”¨ | ç¤ºä¾‹ |
| :--- | :--- | :--- |
| **`http_send_text`** | å‘é€æ™®é€šæ–‡æœ¬ (`text/plain`) | `http_send_text(conn, 200, "Hello!", epollFd);` |
| **`http_send_json`** | å‘é€ JSON å­—ç¬¦ä¸² (`application/json`) | `http_send_json(conn, 200, "{\"ok\":true}", epollFd);` |
| **`http_send_json_doc`** | **[å¼ºåŠ›]** ç›´æ¥å‘é€ `yyjson` æ–‡æ¡£ | `http_send_json_doc(conn, 200, doc, epollFd);` |
| **`http_send_error`** | å‘é€æ ‡å‡†é”™è¯¯é¡µ | `http_send_error(conn, 404, "Not Found", epollFd);` |

### æ¨¡å¼ Bï¼šæ‰‹æœ¯åˆ€å¼æ§åˆ¶ (Struct Manipulation) ğŸ”ª

å¦‚æœä½ éœ€è¦è®¾ç½®ç‰¹æ®Šçš„ Headerï¼ˆæ¯”å¦‚ Set-Cookieï¼‰ï¼Œæˆ–è€…éœ€è¦ç²¾ç»†æ§åˆ¶çŠ¶æ€ç ï¼Œå¯ä»¥ä½¿ç”¨ç»“æ„ä½“æ“ä½œã€‚

```c
// 1. åˆå§‹åŒ–
HttpResponse res;
http_response_init(&res, 201); // 201 Created

// 2. è®¾ç½® Header (Max 16 headers)
http_response_set_header(&res, "X-Powered-By", "EpollServer/1.0");
http_response_set_header(&res, "Set-Cookie", "session_id=xyz; Path=/");

// 3. è®¾ç½®å†…å®¹ç±»å‹å’Œ Body
http_response_set_content_type(&res, "application/xml");
http_response_set_body(&res, "<xml>...</xml>", len);

// 4. å‘é€ï¼
http_response_send(conn, &res, epollFd);
```

### JSON å“åº”æ„å»ºæœ€ä½³å®è·µ

ç»“åˆ `yyjson` å’Œ `http_send_json_doc`ï¼Œä½ å¯ä»¥æå…¶ä¼˜é›…åœ°æ„å»ºå“åº”ï¼š

```c
// åˆ›å»ºä¸€ä¸ªå¯å˜æ–‡æ¡£
yyjson_mut_doc* doc = yyjson_mut_doc_new(NULL);
yyjson_mut_val* root = yyjson_mut_obj(doc);
yyjson_mut_doc_set_root(doc, root);

// åƒæ“ä½œå¯¹è±¡ä¸€æ ·æ·»åŠ å­—æ®µ
yyjson_mut_obj_add_str(doc, root, "status", "success");
yyjson_mut_obj_add_int(doc, root, "count", 42);

// ä¸€è¡Œä»£ç å‘é€ (æ¡†æ¶ä¼šè‡ªåŠ¨åºåˆ—åŒ–å¹¶é‡Šæ”¾ buffer)
http_send_json_doc(conn, 200, doc, epollFd);

// âš ï¸ é‡è¦ï¼šä½ åªéœ€è¦é‡Šæ”¾ doc æœ¬èº«ï¼Œå‘é€å‡½æ•°å†…éƒ¨ä¼šå¤„ç†åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²
yyjson_mut_doc_free(doc);
```

---

## 5. ğŸ“ æ—¥å¿—ç³»ç»Ÿæ ¼å¼è¯´æ˜

æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œä½äºé…ç½®æ–‡ä»¶æŒ‡å®šçš„ `LogPath` (é»˜è®¤ä¸º `log/`) ç›®å½•ä¸‹ã€‚

### `access.log` (è®¿é—®æ—¥å¿—)
è®°å½•æ¯ä¸€ä¸ª HTTP è¯·æ±‚çš„æ‘˜è¦ã€‚
**æ ¼å¼**ï¼š`[æ—¶é—´] [IP] "METHOD URI" çŠ¶æ€ç `
**ç¤ºä¾‹**ï¼š
```text
[2025-12-10 10:00:01] [127.0.0.1] "GET /api/me" 200
[2025-12-10 10:00:05] [192.168.1.5] "POST /api/login" 401
```

### `system.log` (ç³»ç»Ÿæ—¥å¿—)
è®°å½•æœåŠ¡å™¨å†…éƒ¨çš„è¿è¡ŒçŠ¶æ€ã€é”™è¯¯å †æ ˆå’Œè°ƒè¯•ä¿¡æ¯ã€‚
**æ ¼å¼**ï¼š`[æ—¶é—´] [çº§åˆ«] ä¿¡æ¯`
**ç¤ºä¾‹**ï¼š
```text
[2025-12-10 09:59:59] [INFO] Logger initialized.
[2025-12-10 09:59:59] [INFO] Server starting on port 8888...
[2025-12-10 10:05:00] [WARNING] Path traversal attempt blocked for URI '../etc/passwd'
```

---

## 6. å¸¸è§é—®é¢˜ (FAQ)

**Q: ä¸ºä»€ä¹ˆæˆ‘ä¿®æ”¹äº† `epoll_server_core` é‡Œçš„ä»£ç ï¼Œ`make` æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ**
A: è¯·ä½¿ç”¨ `make clean_all` ç„¶å `make`ï¼Œæˆ–è€…ç›´æ¥ `make rebuild`ã€‚æœ‰æ—¶å€™é™æ€åº“çš„é“¾æ¥éœ€è¦å¼ºåˆ¶åˆ·æ–°ã€‚

**Q: å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ–°çš„ APIï¼Ÿ**
A: 
1. åœ¨ `api.h` å£°æ˜å‡½æ•°ã€‚
2. åœ¨ `api.c` å®ç°å‡½æ•°ã€‚
3. åœ¨ `main.c` ä½¿ç”¨ `router_add_route("GET", "/api/xxx", handle_xxx)` æ³¨å†Œã€‚

**Q: å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ**
A: ç›®å‰æ ¸å¿ƒæ˜¯**å•çº¿ç¨‹ Reactor æ¨¡å‹**ã€‚æ‰€æœ‰çš„å›è°ƒå‡½æ•°éƒ½åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œã€‚å› æ­¤ï¼Œä½ ä¸éœ€è¦åœ¨è¿™ä¸ªå›è°ƒé‡ŒåŠ é”ï¼Œä½†åŒæ—¶ä¹Ÿ**ç»å¯¹ä¸èƒ½**åœ¨å›è°ƒé‡Œå†™æ­»å¾ªç¯æˆ–æ‰§è¡Œè€—æ—¶è¶…è¿‡å‡ æ¯«ç§’çš„é˜»å¡æ“ä½œï¼ˆå¦‚ `sleep` æˆ–æ…¢ SQLï¼‰ï¼Œå¦åˆ™æ•´ä¸ªæœåŠ¡å™¨ä¼šå¡ä½ã€‚

---

*Happy Coding!* ğŸš€
